<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraSense - Routes & Roads Tracing with Multi-API Integration</title>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Drawing -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- Leaflet Routing -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Bootstrap for UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .container-main {
            display: flex;
            height: calc(100vh - 100px);
            gap: 0;
        }
        
        #map {
            flex: 1;
            background: #e0e0e0;
            position: relative;
        }
        
        .sidebar {
            width: 400px;
            background: white;
            overflow-y: auto;
            border-left: 1px solid #ddd;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }
        
        .control-section {
            margin-bottom: 25px;
        }
        
        .control-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 100px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .api-indicators {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .api-indicator {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
        }
        
        .api-indicator.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .api-indicator.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .api-indicator::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .api-indicator.active::before {
            background: #28a745;
        }
        
        .api-indicator.inactive::before {
            background: #dc3545;
        }
        
        .route-card,
        .road-card {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .route-card:hover,
        .road-card:hover {
            background: #f0f0f0;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .route-card h4,
        .road-card h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .route-info,
        .road-info {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }
        
        .info-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
            margin-top: 3px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 10px;
            color: #999;
        }
        
        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .tab-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            padding: 10px 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Map markers */
        .marker-icon-origin {
            background: #48bb78;
        }
        
        .marker-icon-destination {
            background: #f56565;
        }
        
        /* Leaflet polyline styling (applied via JavaScript) */
        /* .route-line: color #667eea, weight 3, opacity 0.8 */
        /* .osm-road: color #764ba2, weight 2, opacity 0.6 */
        /* .concern-circle: color #f59e0b, fillOpacity 0.3 */
        
        @media (max-width: 768px) {
            .container-main {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üó∫Ô∏è InfraSense - Routes & Roads Tracing</h1>
        <p>Multi-API Integration: Google Maps + OpenStreetMap + OpenAI GPT-4 + Xai Grok</p>
    </div>
    
    <!-- Main Container -->
    <div class="container-main">
        <!-- Map -->
        <div id="map"></div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- API Status -->
            <div class="control-section">
                <h3>üîå API Status</h3>
                <div class="api-indicators">
                    <div class="api-indicator active" id="api-google">
                        Google Maps
                    </div>
                    <div class="api-indicator active" id="api-osm">
                        OpenStreetMap
                    </div>
                    <div class="api-indicator active" id="api-openai">
                        OpenAI GPT-4
                    </div>
                    <div class="api-indicator active" id="api-grok">
                        Xai Grok
                    </div>
                </div>
            </div>
            
            <!-- Route Planning -->
            <div class="control-section">
                <h3>üß≠ Route Planning</h3>
                <div class="form-group">
                    <label>Origin (lat, lng)</label>
                    <input type="text" id="origin" placeholder="28.6139, 77.2090" value="28.6139, 77.2090">
                </div>
                <div class="form-group">
                    <label>Destination (lat, lng)</label>
                    <input type="text" id="destination" placeholder="28.5244, 77.0855" value="28.5244, 77.0855">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="getComprehensiveRoutes()">
                        üìç Trace Route
                    </button>
                    <button class="btn-secondary" onclick="getTrafficAnalysis()">
                        üöó Traffic
                    </button>
                </div>
            </div>
            
            <!-- Road Analysis -->
            <div class="control-section">
                <h3>üõ£Ô∏è Road Analysis</h3>
                <div class="form-group">
                    <label>Latitude</label>
                    <input type="text" id="road-lat" placeholder="28.6139" value="28.6139">
                </div>
                <div class="form-group">
                    <label>Longitude</label>
                    <input type="text" id="road-lng" placeholder="77.2090" value="77.2090">
                </div>
                <div class="form-group">
                    <label>Road Type</label>
                    <select id="road-type">
                        <option value="all">All Roads</option>
                        <option value="primary">Primary</option>
                        <option value="secondary">Secondary</option>
                        <option value="tertiary">Tertiary</option>
                        <option value="residential">Residential</option>
                        <option value="motorway">Motorway</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="getComprehensiveRoads()">
                        üõ£Ô∏è Get Roads
                    </button>
                    <button class="btn-secondary" onclick="getDetailedRoads()">
                        üìä Detailed
                    </button>
                </div>
            </div>
            
            <!-- Tools -->
            <div class="control-section">
                <h3>üõ†Ô∏è Tools</h3>
                <div class="button-group">
                    <button class="btn-secondary" onclick="clearMap()">
                        üóëÔ∏è Clear Map
                    </button>
                    <button class="btn-secondary" onclick="toggleDrawing()">
                        ‚úèÔ∏è Draw Region
                    </button>
                </div>
            </div>
            
            <!-- Results Tabs -->
            <div class="control-section">
                <h3>üìä Results</h3>
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('routes')">Routes</button>
                    <button class="tab-btn" onclick="switchTab('roads')">Roads</button>
                    <button class="tab-btn" onclick="switchTab('analysis')">Analysis</button>
                </div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading data from all APIs...</p>
                </div>
                
                <div id="routes-tab" class="tab-content active results"></div>
                <div id="roads-tab" class="tab-content results"></div>
                <div id="analysis-tab" class="tab-content results"></div>
                
                <div id="empty-state" class="empty-state">
                    <p>Select a location and click "Trace Route" or "Get Roads"</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            const map = L.map('map').setView([28.6139, 77.2090], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        
        // Add drawing layer
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        const drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: {
                polygon: true,
                rectangle: true,
                circle: false,
                marker: false,
                polyline: false
            }
        });
        
        let drawingEnabled = false;
        
        map.on('draw:created', function(e) {
            drawnItems.addLayer(e.layer);
        });
        
        // Helper functions
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('empty-state').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        async function getComprehensiveRoutes() {
            const origin = document.getElementById('origin').value.split(',').map(s => parseFloat(s.trim()));
            const dest = document.getElementById('destination').value.split(',').map(s => parseFloat(s.trim()));
            
            if (origin.length !== 2 || dest.length !== 2) {
                alert('Please enter valid coordinates (lat, lng)');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(
                    `/api/routes/comprehensive?origin_lat=${origin[0]}&origin_lng=${origin[1]}&dest_lat=${dest[0]}&dest_lng=${dest[1]}`
                );
                
                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.json();
                displayRoutes(data.routes);
                
                // Add markers to map
                L.circleMarker([origin[0], origin[1]], {
                    radius: 8,
                    fillColor: '#48bb78',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup('Origin');
                
                L.circleMarker([dest[0], dest[1]], {
                    radius: 8,
                    fillColor: '#f56565',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup('Destination');
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error fetching routes: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function getComprehensiveRoads() {
            const lat = parseFloat(document.getElementById('road-lat').value);
            const lng = parseFloat(document.getElementById('road-lng').value);
            const radius = 5000;
            
            if (!lat || !lng) {
                alert('Please enter valid coordinates');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(
                    `/api/roads/comprehensive?lat=${lat}&lng=${lng}&radius=${radius}`
                );
                
                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.json();
                displayRoads(data.roads);
                
                // Add center marker
                L.circleMarker([lat, lng], {
                    radius: 6,
                    fillColor: '#667eea',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup('Search Center');
                
                // Add roads to map
                data.roads.forEach((road, idx) => {
                    if (road.coordinates && road.coordinates.length > 1) {
                        const latLngs = road.coordinates.map(c => [c[0], c[1]]);
                        L.polyline(latLngs, {
                            color: '#764ba2',
                            weight: 2,
                            opacity: 0.6
                        }).addTo(map).bindPopup(road.name || `Road ${idx + 1}`);
                    }
                });
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error fetching roads: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function displayRoutes(routes) {
            const container = document.getElementById('routes-tab');
            container.innerHTML = '';
            
            if (!routes || Object.keys(routes).length === 0) {
                container.innerHTML = '<p class="empty-state">No routes found</p>';
                document.getElementById('empty-state').style.display = 'none';
                return;
            }
            
            // Google Maps routes
            if (routes.google_maps && routes.google_maps.routes) {
                routes.google_maps.routes.forEach((route, idx) => {
                    const leg = route.legs[0];
                    const html = `
                        <div class="route-card">
                            <h4>üó∫Ô∏è Google Maps Route ${idx + 1}</h4>
                            <div class="route-info">
                                <div><strong>Distance:</strong> ${leg.distance.text}</div>
                                <div><strong>Duration:</strong> ${leg.duration.text}</div>
                                ${leg.duration_in_traffic ? `<div><strong>In Traffic:</strong> ${leg.duration_in_traffic.text}</div>` : ''}
                                <div style="margin-top: 8px;">
                                    <span class="info-badge">üöó Verified</span>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            }
            
            // OSM roads on route
            if (routes.osm_roads && routes.osm_roads.length > 0) {
                routes.osm_roads.forEach((road, idx) => {
                    const html = `
                        <div class="route-card">
                            <h4>üó∫Ô∏è OSM Road ${idx + 1}</h4>
                            <div class="route-info">
                                <div><strong>Name:</strong> ${road.name || 'Unknown'}</div>
                                <div><strong>Surface:</strong> ${road.surface || 'Unknown'}</div>
                                <div><strong>Length:</strong> ${(road.length / 1000).toFixed(2)} km</div>
                                <div style="margin-top: 8px;">
                                    <span class="info-badge">üó∫Ô∏è Mapped</span>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            }
            
            document.getElementById('empty-state').style.display = 'none';
        }
        
        function displayRoads(roads) {
            const container = document.getElementById('roads-tab');
            container.innerHTML = '';
            
            if (!roads || roads.length === 0) {
                container.innerHTML = '<p class="empty-state">No roads found</p>';
                document.getElementById('empty-state').style.display = 'none';
                return;
            }
            
            roads.forEach((road, idx) => {
                const html = `
                    <div class="road-card">
                        <h4>üõ£Ô∏è ${road.name || `Road ${idx + 1}`}</h4>
                        <div class="road-info">
                            <div><strong>Type:</strong> ${road.type || 'Unknown'}</div>
                            <div><strong>Surface:</strong> ${road.surface || 'Unknown'}</div>
                            <div><strong>Condition:</strong> ${road.condition || 'Good'}</div>
                            ${road.speed_limit ? `<div><strong>Speed Limit:</strong> ${road.speed_limit} km/h</div>` : ''}
                            ${road.lanes ? `<div><strong>Lanes:</strong> ${road.lanes}</div>` : ''}
                            <div style="margin-top: 8px;">
                                <span class="info-badge">‚úì Real Data</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
            
            document.getElementById('empty-state').style.display = 'none';
        }
        
        async function getTrafficAnalysis() {
            const origin = document.getElementById('origin').value.split(',').map(s => parseFloat(s.trim()));
            const dest = document.getElementById('destination').value.split(',').map(s => parseFloat(s.trim()));
            
            if (origin.length !== 2 || dest.length !== 2) {
                alert('Please enter valid coordinates');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(
                    `/api/routes/traffic-analysis?origin_lat=${origin[0]}&origin_lng=${origin[1]}&dest_lat=${dest[0]}&dest_lng=${dest[1]}`
                );
                
                const data = await response.json();
                const container = document.getElementById('analysis-tab');
                
                let html = '<h5>üöó Traffic Analysis</h5>';
                if (data.routes && data.routes.length > 0) {
                    data.routes.forEach((route, idx) => {
                        html += `
                            <div class="route-card">
                                <h4>Route ${idx + 1}</h4>
                                <div class="route-info">
                                    <div><strong>Distance:</strong> ${route.distance}</div>
                                    <div><strong>Duration:</strong> ${route.duration}</div>
                                    <div><strong>In Traffic:</strong> ${route.duration_in_traffic}</div>
                                    <div style="margin-top: 8px;">
                                        <span class="info-badge">üìä Traffic Data</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                switchTab('analysis');
                
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function getDetailedRoads() {
            const lat = parseFloat(document.getElementById('road-lat').value);
            const lng = parseFloat(document.getElementById('road-lng').value);
            const roadType = document.getElementById('road-type').value;
            
            if (!lat || !lng) {
                alert('Please enter valid coordinates');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(
                    `/api/roads/detailed?lat=${lat}&lng=${lng}&road_type=${roadType}`
                );
                
                const data = await response.json();
                const container = document.getElementById('analysis-tab');
                
                let html = `<h5>üìä Detailed Roads (${roadType})</h5>`;
                html += `<p style="font-size: 12px; color: #666;">Found ${data.total_found} roads</p>`;
                
                if (data.roads && data.roads.length > 0) {
                    data.roads.forEach((road, idx) => {
                        html += `
                            <div class="road-card">
                                <h4>${road.name || `Road ${idx + 1}`}</h4>
                                <div class="road-info">
                                    <div><strong>Type:</strong> ${road.type}</div>
                                    <div><strong>Surface:</strong> ${road.surface || 'Unknown'}</div>
                                    <div><strong>Lanes:</strong> ${road.lanes || 'Unknown'}</div>
                                    <div><strong>Speed:</strong> ${road.speed_limit || 'N/A'}</div>
                                    ${road.detailed_analysis ? `<div style="margin-top: 8px;"><strong>Analysis:</strong> ${JSON.stringify(road.detailed_analysis).substring(0, 100)}...</div>` : ''}
                                    <div style="margin-top: 8px;">
                                        <span class="info-badge">üìä Detailed</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                switchTab('analysis');
                
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function toggleDrawing() {
            if (!drawingEnabled) {
                map.addControl(drawControl);
                drawingEnabled = true;
                alert('Drawing enabled. Draw a polygon or rectangle on the map to filter concerns.');
            } else {
                map.removeControl(drawControl);
                drawingEnabled = false;
            }
        }
        
        function clearMap() {
            // Clear all layers except base map
            map.eachLayer(function(layer) {
                if (layer instanceof L.Polyline || layer instanceof L.CircleMarker || layer instanceof L.Polygon) {
                    map.removeLayer(layer);
                }
            });
            drawnItems.clearLayers();
        }
        
        }); // Close DOMContentLoaded
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
